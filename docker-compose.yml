version: '3.8'

services:
  # PostgreSQL 数据库
  postgres:
    image: postgres:16-bookworm
    container_name: ops-postgres
    restart: unless-stopped

    environment:
      POSTGRES_DB: ${POSTGRES_DB:-ops_service}
      POSTGRES_USER: ${POSTGRES_USER:-ops_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      PGDATA: /var/lib/postgresql/data/pgdata

    volumes:
      - postgres_data:/var/lib/postgresql/data

    ports:
      - "127.0.0.1:5432:5432"  # 仅绑定 localhost，不对外暴露

    networks:
      - ops_internal

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-ops_user}"]
      interval: 10s
      timeout: 5s
      retries: 5

    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # API 服务
  api:
    build:
      context: .
      dockerfile: Dockerfile

    container_name: ops-api
    restart: unless-stopped

    environment:
      # 服务器配置
      OPS_SERVER__ADDR: 0.0.0.0:3000
      OPS_SERVER__GRACEFUL_SHUTDOWN_TIMEOUT_SECS: 30

      # 数据库配置
      OPS_DATABASE__URL: postgresql://${POSTGRES_USER:-ops_user}:${POSTGRES_PASSWORD:-changeme}@postgres:5432/${POSTGRES_DB:-ops_service}
      OPS_DATABASE__MAX_CONNECTIONS: 10
      OPS_DATABASE__MIN_CONNECTIONS: 2
      OPS_DATABASE__ACQUIRE_TIMEOUT_SECS: 30
      OPS_DATABASE__IDLE_TIMEOUT_SECS: 600
      OPS_DATABASE__MAX_LIFETIME_SECS: 1800

      # 日志配置
      OPS_LOGGING__LEVEL: ${LOG_LEVEL:-info}
      OPS_LOGGING__FORMAT: json

      # 安全配置
      OPS_SECURITY__RATE_LIMIT_RPS: 100
      OPS_SECURITY__TRUST_PROXY: "true"
      OPS_SECURITY__ALLOWED_IPS: ${ALLOWED_IPS:-}

    depends_on:
      postgres:
        condition: service_healthy

    networks:
      - ops_internal

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

    # 不暴露端口，仅通过 Nginx 访问

  # Nginx 反向代理
  nginx:
    image: nginx:1.25-bookworm
    container_name: ops-nginx
    restart: unless-stopped

    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl.conf:/etc/nginx/conf.d/ssl.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro  # SSL 证书目录

    ports:
      - "80:80"   # HTTP（重定向到 HTTPS）
      - "443:443" # HTTPS

    depends_on:
      - api

    networks:
      - ops_internal

    healthcheck:
      test: ["CMD", "curl", "-f", "https://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3

networks:
  ops_internal:
    driver: bridge

volumes:
  postgres_data:
    driver: local
