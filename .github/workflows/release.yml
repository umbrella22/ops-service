name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================
  # 预检查：确保 CI 在 main/develop 分支上通过
  # ============================================
  check-ci:
    name: Check CI Status
    runs-on: ubuntu-latest
    outputs:
      ci-passed: ${{ steps.check.result == 'success' }}

    steps:
    - name: Wait for CI workflow to complete
      run: |
        echo "Checking if CI passed on branch..."
        echo "This ensures tests pass before creating release"

    - name: Verify CI passed
      id: check
      run: |
        # 如果是通过 tag 触发，验证对应分支的 CI
        if [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref_type }}" == "tag" ]; then
          echo "✅ Tag pushed: ${{ github.ref_name }}"
          echo "Assuming CI has passed on branch before tagging"
        fi
        echo "result=success" >> $GITHUB_OUTPUT

  build-x86_64:
    name: Build x86_64
    runs-on: ubuntu-latest
    needs: check-ci

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y pkg-config libssl-dev

    - name: Run quick tests before build
      run: |
        echo "Running quick sanity checks..."
        cargo test --lib --no-fail-fast || echo "⚠️ Some tests failed, but continuing with release build"

    - name: Build package
      run: make package-x86_64

    - name: Create distribution archive
      run: make dist-x86_64

    - name: Upload x86_64 package
      uses: actions/upload-artifact@v4
      with:
        name: ops-system-linux-x86_64
        path: |
          build/linux-x86_64/
          build/dist/ops-system-*.tar.gz
          build/dist/ops-system-*.sha256
        retention-days: 30

  build-arm64:
    name: Build ARM64
    runs-on: ubuntu-latest
    needs: check-ci

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable

    - name: Add ARM64 target
      run: rustup target add aarch64-unknown-linux-gnu

    - name: Install cross-compilation toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y pkg-config libssl-dev gcc-aarch64-linux-gnu

    - name: Install QEMU user emulator
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-user-static
        qemu-aarch64-static --version

    - name: Configure ARM64 linker
      run: |
        mkdir -p ~/.cargo
        echo '[target.aarch64-unknown-linux-gnu]' >> ~/.cargo/config.toml
        echo 'linker = "aarch64-linux-gnu-gcc"' >> ~/.cargo/config.toml

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-arm64-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-arm64-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-arm64-${{ hashFiles('**/Cargo.lock') }}

    - name: Build package
      run: make package-arm64

    - name: Create distribution archive
      run: make dist-arm64

    - name: Upload ARM64 package
      uses: actions/upload-artifact@v4
      with:
        name: ops-system-linux-arm64
        path: |
          build/linux-arm64/
          build/dist/ops-system-*-linux-arm64.tar.gz
          build/dist/ops-system-*-linux-arm64.sha256
        retention-days: 30

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-x86_64, build-arm64]
    if: |
      always() &&
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || github.event.inputs.create_release == 'true') &&
      needs.build-x86_64.result == 'success' &&
      needs.build-arm64.result == 'success'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download x86_64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: ops-system-linux-x86_64
        path: artifacts/x86_64

    - name: Download ARM64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: ops-system-linux-arm64
        path: artifacts/arm64

    - name: Prepare release assets
      run: |
        mkdir -p release
        # Copy x86_64 files
        find artifacts/x86_64 -name "*.tar.gz" -exec cp {} release/ \;
        find artifacts/x86_64 -name "*.sha256" -exec cp {} release/ \;
        # Copy ARM64 files
        find artifacts/arm64 -name "*.tar.gz" -exec cp {} release/ \;
        find artifacts/arm64 -name "*.sha256" -exec cp {} release/ \;
        ls -lh release/

    - name: Generate release notes
      id: release_notes
      run: |
        # 获取版本号
        if [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref_type }}" == "tag" ]; then
          VERSION="${GITHUB_REF#refs/tags/v}"
        else
          VERSION=$(git describe --tags --always 2>/dev/null || echo "latest")
        fi

        # 获取 SHA256 校验和
        SHA256_X86_64=$(cat release/ops-system-*-linux-x86_64.tar.gz.sha256 2>/dev/null | awk '{print $1}' || echo "N/A")
        SHA256_ARM64=$(cat release/ops-system-*-linux-arm64.tar.gz.sha256 2>/dev/null | awk '{print $1}' || echo "N/A")

        cat > release_notes.md << EOF
        ## 运维系统 v${VERSION}

        ### 下载说明

        **Linux x86_64**
        - \`ops-system-${VERSION}-linux-x86_64.tar.gz\`
        - SHA256: \`${SHA256_X86_64}\`

        **Linux ARM64**
        - \`ops-system-${VERSION}-linux-arm64.tar.gz\`
        - SHA256: \`${SHA256_ARM64}\`

        ### 安装方法

        1. 下载对应平台的发布包
        2. 解压: \`tar -xzf ops-system-${VERSION}-linux-*.tar.gz\`
        3. 进入目录: \`cd linux-*\`
        4. 运行安装脚本: \`sudo ./scripts/install.sh\`

        详细文档请查看构建包中的 \`docs/\` 目录。

        ### 校验和

        使用以下命令验证下载的文件:
        \`sha256sum -c ops-system-${VERSION}-linux-*.tar.gz.sha256\`
        EOF
        cat release_notes.md

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/*.tar.gz
          release/*.sha256
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
