# Deployment Guide for {{BINARY_NAME}} v{{VERSION}}

## Table of Contents
- [System Requirements](#system-requirements)
- [Installation Modes](#installation-modes)
- [Quick Start](#quick-start)
- [Installation](#installation)
- [Configuration](#configuration)
- [Service Management](#service-management)
- [Verification](#verification)
- [Docker Deployment](#docker-deployment)
- [Troubleshooting](#troubleshooting)
- [Upgrade](#upgrade)
- [Uninstallation](#uninstallation)

## System Requirements

### Minimum Requirements
- **OS**: Linux (x86_64 or ARM64)
- **RAM**: 512 MB minimum, 1 GB recommended
- **Disk**: 100 MB for binary + space for database
- **CPU**: 1 core minimum

### Software Dependencies

#### Native Mode
- PostgreSQL 12+
- systemd (for service management)

#### Docker Mode (Recommended)
- Docker 20.10+
- Docker Compose 2.0+

### Optional Dependencies
- Nginx (for reverse proxy)
- curl (for health checks)

## Installation Modes

{{BINARY_NAME}} supports two installation modes:

### 1. Docker Mode (Recommended)

**Advantages:**
- ✅ All services run in isolated containers
- ✅ Easier to manage and upgrade
- ✅ No manual PostgreSQL setup required
- ✅ One-command start and stop

**Disadvantages:**
- Requires Docker and Docker Compose
- Slightly higher resource usage

**Best for:**
- Production deployments
- Quick testing and development
- Users who don't want to manage databases manually

### 2. Native Mode

**Advantages:**
- Runs as a systemd service
- Lower resource footprint
- Can use system's PostgreSQL

**Disadvantages:**
- Requires manual PostgreSQL installation and configuration
- More complex setup

**Best for:**
- Environments with existing PostgreSQL servers
- Need for deep system integration
- Resource-constrained environments

## Quick Start

### Using One-Click Init Script (Recommended)

```bash
# 1. Extract the archive
tar -xzf {{BINARY_NAME}}-{{VERSION}}-linux-{{PLATFORM}}.tar.gz
cd linux-{{PLATFORM}}

# 2. Run the one-click initialization script
sudo ./init.sh
```

The init script will:
1. Detect if Docker is installed on your system
2. Ask you to choose installation mode (if Docker is detected)
3. Ask whether to load seed data (demo users and sample data)
4. Automatically complete installation and start the service

### Manual Installation

If you need more control, you can run the install script manually:

```bash
# Docker mode installation
sudo ./scripts/install.sh --docker --seed-data

# Native mode installation
sudo ./scripts/install.sh --native --seed-data

# Without seed data
sudo ./scripts/install.sh --docker --no-seed-data
```

## Installation

### Docker Mode Installation

```bash
# 1. Extract and enter directory
tar -xzf {{BINARY_NAME}}-{{VERSION}}-linux-{{PLATFORM}}.tar.gz
cd linux-{{PLATFORM}}

# 2. Run install script
sudo ./scripts/install.sh --docker

# 3. Review generated configuration
cat /etc/{{BINARY_NAME}}/docker/.env

# 4. Start services
cd /etc/{{BINARY_NAME}}/docker
docker-compose up -d

# 5. View logs
docker-compose logs -f
```

### Native Mode Installation

```bash
# 1. Install PostgreSQL
sudo apt install postgresql postgresql-contrib  # Ubuntu/Debian
# or
sudo yum install postgresql-server postgresql  # RHEL/CentOS

# 2. Start PostgreSQL
sudo systemctl start postgresql
sudo systemctl enable postgresql

# 3. Create database
sudo -u postgres psql
CREATE DATABASE ops_system;
CREATE USER ops_user WITH ENCRYPTED PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE ops_system TO ops_user;
\q

# 4. Extract and install
tar -xzf {{BINARY_NAME}}-{{VERSION}}-linux-{{PLATFORM}}.tar.gz
cd linux-{{PLATFORM}}

# 5. Run install script
sudo ./scripts/install.sh --native

# 6. Edit configuration file
sudo nano /etc/{{BINARY_NAME}}/env
# Set database URL: OPS_DATABASE__URL=postgresql://ops_user:your_password@127.0.0.1:5432/ops_system

# 7. Start service
sudo ./scripts/start.sh
```

## Configuration

### Docker Mode Configuration

Configuration file location: `/etc/{{BINARY_NAME}}/docker/.env`

```bash
# PostgreSQL Configuration
POSTGRES_DB=ops_system
POSTGRES_USER=ops_user
POSTGRES_PASSWORD=<auto-generated-random-password>

# Application Configuration
LOG_LEVEL=info
ALLOWED_IPS=

# Seed Data Configuration
LOAD_SEED_DATA=true  # true or false
```

To apply configuration changes:
```bash
cd /etc/{{BINARY_NAME}}/docker
docker-compose restart
```

### Native Mode Configuration

Configuration file location: `/etc/{{BINARY_NAME}}/env`

```bash
# Database configuration (NOTE: Use double underscore __ for nested fields)
OPS_DATABASE__URL=postgresql://user:password@127.0.0.1:5432/ops_system
OPS_DATABASE__MAX_CONNECTIONS=10
OPS_DATABASE__MIN_CONNECTIONS=2

# Server configuration
OPS_SERVER__ADDR=0.0.0.0:3000

# Security configuration
OPS_SECURITY__JWT_SECRET=your-random-secret-key-min-32-chars
OPS_SECURITY__RATE_LIMIT_RPS=100

# Logging configuration
OPS_LOGGING__LEVEL=info
```

After editing the configuration, restart the service:
```bash
sudo systemctl restart {{BINARY_NAME}}
```

## Service Management

### Using Management Scripts (Recommended)

All scripts automatically detect installation mode and act accordingly:

```bash
# Start service
sudo ./scripts/start.sh

# Stop service
sudo ./scripts/stop.sh

# Restart service
sudo ./scripts/restart.sh

# Check status
sudo ./scripts/status.sh

# Backup data
sudo ./scripts/backup.sh

# Update version
sudo ./scripts/update.sh

# Uninstall
sudo ./scripts/uninstall.sh
```

### Docker Mode Specific Commands

```bash
# Enter docker directory
cd /etc/{{BINARY_NAME}}/docker

# View logs
docker-compose logs -f

# Check container status
docker-compose ps

# Restart specific service
docker-compose restart api

# Stop all services
docker-compose down

# Start all services
docker-compose up -d
```

### Native Mode Specific Commands

```bash
# Enable on boot
sudo systemctl enable {{BINARY_NAME}}

# Disable on boot
sudo systemctl disable {{BINARY_NAME}}

# View live logs
sudo journalctl -u {{BINARY_NAME}} -f

# View recent logs
sudo journalctl -u {{BINARY_NAME}} -n 100
```


## Verification

### Health Check

```bash
# Using curl
curl http://localhost:3000/health

# Expected output
{"status":"ok"}
```

### Ready Check

```bash
curl http://localhost:3000/ready

# Expected output if database is connected
{"status":"ready"}
```

### Check Logs

```bash
sudo journalctl -u {{BINARY_NAME}} -n 50
```

## Docker Deployment

### Quick Docker Deployment

```bash
# 1. Extract archive
tar -xzf {{BINARY_NAME}}-{{VERSION}}-linux-{{PLATFORM}}.tar.gz
cd linux-{{PLATFORM}}

# 2. Run installer
sudo ./scripts/install.sh --docker

# 3. Start services
cd /etc/{{BINARY_NAME}}/docker
docker-compose up -d
```

### Services Deployed

When using Docker mode, the following services are deployed:
- **PostgreSQL database** (port 5432, localhost only)
- **API service** (internal, accessible via Nginx)
- **Nginx reverse proxy** (ports 80, 443)

All services are configured with automatic restart and health checks.

### Managing Docker Services

```bash
cd /etc/{{BINARY_NAME}}/docker

# View all services
docker-compose ps

# View logs
docker-compose logs -f

# Restart all services
docker-compose restart

# Stop all services
docker-compose down

# Start all services
docker-compose up -d
```

## Troubleshooting

### Service Won't Start

1. **Check logs:**
   ```bash
   # Docker mode
   cd /etc/{{BINARY_NAME}}/docker && docker-compose logs

   # Native mode
   sudo journalctl -u {{BINARY_NAME}} -n 100
   ```

2. **Verify configuration:**
   ```bash
   # Docker mode
   cat /etc/{{BINARY_NAME}}/docker/.env

   # Native mode
   cat /etc/{{BINARY_NAME}}/env
   ```

3. **Check database connection:**
   ```bash
   # Docker mode
   docker exec -it <postgres_container> psql -U ops_user -d ops_system

   # Native mode
   psql "postgresql://user:pass@127.0.0.1:5432/ops_system"
   ```

### Permission Issues

```bash
# Fix permissions
sudo chown -R {{BINARY_NAME}}:{{BINARY_NAME}} /var/lib/{{BINARY_NAME}}
sudo chown -R {{BINARY_NAME}}:{{BINARY_NAME}} /var/log/{{BINARY_NAME}}
sudo chmod 640 /etc/{{BINARY_NAME}}/env
```

### Database Connection Errors

1. Verify PostgreSQL is running:
   ```bash
   sudo systemctl status postgresql
   ```

2. Check connection string:
   - Native mode: `/etc/{{BINARY_NAME}}/env`
   - Docker mode: `/etc/{{BINARY_NAME}}/docker/.env`

3. Ensure database exists and user has permissions

### Port Already in Use

Change the port in configuration:
```bash
# Native mode - edit /etc/{{BINARY_NAME}}/env
OPS_SERVER__ADDR=0.0.0.0:3001

# Docker mode - edit /etc/{{BINARY_NAME}}/docker/.env
# Then modify docker-compose.yml port mappings
```

## Upgrade

### Using Update Script (Recommended)

```bash
# 1. Extract new version
tar -xzf {{BINARY_NAME}}-{{NEW_VERSION}}-linux-{{PLATFORM}}.tar.gz
cd linux-{{PLATFORM}}

# 2. Run update script (automatically backs up and updates)
sudo ./scripts/update.sh

# 3. Verify upgrade
./scripts/status.sh
```

### Manual Upgrade

```bash
# 1. Backup current version
sudo ./scripts/backup.sh

# 2. Stop service
sudo ./scripts/stop.sh

# 3. Replace binary
sudo cp bin/{{BINARY_NAME}} /usr/local/bin/
sudo chmod +x /usr/local/bin/{{BINARY_NAME}}

# 4. Start service
sudo ./scripts/start.sh
```

## Uninstallation

### Docker Mode Uninstallation

```bash
# Run uninstall script
sudo ./scripts/uninstall.sh

# Manually remove Docker volumes (optional)
docker volume ls
docker volume rm <volume_name>
```

### Native Mode Uninstallation

```bash
# Run uninstall script
sudo ./scripts/uninstall.sh

# Note: This will remove all data, including:
# - Configuration files in /etc/{{BINARY_NAME}}
# - Data directory /var/lib/{{BINARY_NAME}}
# - Log files in /var/log/{{BINARY_NAME}}
# - System user {{BINARY_NAME}}
# - Database (needs to be dropped manually)
```

### Manually Drop Database

```bash
sudo -u postgres psql
DROP DATABASE ops_system;
DROP USER ops_user;
\q
```

## Clean Installation

If you need to start completely fresh:

```bash
# Clean install removes all data and reinstalls
sudo ./scripts/clean-install.sh

# Note: This operation is irreversible and will permanently delete all data!
```

## Default Accounts

If you chose to load seed data during installation:

| Username | Password | Role | Description |
|----------|----------|------|-------------|
| admin | Admin123! | Administrator | Full access |
| demo | Demo123! | Operator | Limited access |

**⚠️ Important: Change default passwords immediately after first login!**

## More Resources

- [Docker Deployment Guide](DOCKER.md)
- [Security Configuration Guide](SECURITY.md)
- [Troubleshooting Guide](TROUBLESHOOTING.md)
- [Upgrade Guide](UPGRADE.md)

## Get Help

```bash
# Check logs
sudo ./scripts/status.sh

# Check system resources
htop or top

# View full logs
# Docker mode
cd /etc/{{BINARY_NAME}}/docker && docker-compose logs

# Native mode
sudo journalctl -u {{BINARY_NAME}} -f
```

## Next Steps

- Check logs to confirm service is running properly
- Change default passwords
- Configure reverse proxy (Nginx)
- Set up automated backups
- Configure monitoring and alerting
- Review security best practices
